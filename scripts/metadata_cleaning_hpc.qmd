---
title: "metadatacleaning"
format: html
---

# Libraries and Packages

```{r}
library(dplyr)
library(stringr)
library(readr)
library(tidyr)
```

## Setting working directory, loading data

```{r}
setwd("/scratch/grp/msc_appbio/DCDM/Group3")
disease_info <- read_tsv("/scratch/grp/msc_appbio/DCDM/Group3/metadata/Disease_information.txt", col_types = cols(.default = "c"))
IMPC_parameter <- read_csv("/scratch/grp/msc_appbio/DCDM/Group3/metadata/IMPC_parameter_description.txt", col_types = cols(.default = "c"))
IMPC_procedure <- read_csv("/scratch/grp/msc_appbio/DCDM/Group3/metadata/IMPC_procedure.txt", col_types = cols(.default = "c"))
```

# Renaming Columns

## 1. Disease Information

```{r}
disease_info <- disease_info %>%
  rename(DO_Disease_ID = `DO Disease ID`) #DO_Disease_ID
disease_info <- disease_info %>%
  rename(DO_Disease_Name = `DO Disease Name`) #DO_Disease_Name
disease_info <- disease_info %>%
  rename(OMIM_ID = `OMIM IDs`) #OMIM_ID
disease_info <- disease_info %>%
  rename(Mouse_MGI_ID = `Mouse MGI ID`) #Mouse_MGI_ID
```

## 2. IMPC Parameter Description

```{r}
IMPC_parameter <- IMPC_parameter %>%
  rename(parameter_id = parameterId) #parameter_id to match the data
```

# Function to perform initial checks on metadata

```{r}
audit_file <- function(df, name) {
  cat("\n---", name, "---\n")
  cat("Rows:", nrow(df), "| Columns:", ncol(df), "\n") #Prints dimensions of dataset
  cat("Duplicates:", sum(duplicated(df)), "\n") #Checks for duplicate rows

  missing <- colSums(is.na(df)) #Counts NA/missing values 
  missing <- missing[missing > 0]

  if (length(missing) > 0) {
    cat("Missing values:\n")
    print(missing)
  } else {
    cat("No missing values.\n")
  }
}
```

# Initial Checks

## 1. Disease Information

```{r}
audit_file(disease_info, "Disease Information")
# 2925 rows, 4 columns, 0 duplicates, no missing values
```

## 2. IMPC Parameter Description

```{r}
audit_file(IMPC_parameter, "IMPC Parameter Descriptions")
# 5325 rows, 4 columns, 14 duplicates, 2691 missing description entries

# View duplicates
IMPC_parameter %>%
  count(impcParameterOrigId) %>%
  filter (n > 1)
# Duplicates contain exactly the same information so can be removed
```

## 3. IMPC Procedure

```{r}
audit_file(IMPC_procedure, "IMPC Procedure")
# 5311 rows, 4 columns, 0 duplicates, 3481 missing description entires
cat("Empty descriptions:", sum(is.na(IMPC_procedure$description)), "\n") 
```

# Function to check Disease Information format

```{r}
# Checking disease info for inconsistencies
check_disease_info <- function(df) {
  cat("\n--- Disease Format Check ---\n")
  cat("Invalid DOID:", sum(!str_detect(df$`DO_Disease_ID`, "^DOID:\\d+$"), na.rm = TRUE), "\n") #DOID:... format
  cat("Invalid MGI:",  sum(!str_detect(df$`Mouse_MGI_ID`,  "^MGI:\\d+$"),  na.rm = TRUE), "\n") #MGI:.... format
  cat("Multi-OMIM IDs:", sum(str_detect(df$`OMIM_ID`, "\\|"), na.rm = TRUE), "\n") #Checking for multiple OMIMs in a single cell
}
```

## Checking Disease Information format

```{r}
check_disease_info(disease_info)
# 0 invalid DOID, 0 invalid MGI, 422 Multi-OMIM IDs
```

# Function to check IMPC Parameter and IMPC procedure relationship

```{r}
check_integrity <- function(params, procs) {
  cat("--- Parameter-Procedure Integrity ---\n")
  
  # Check for duplicate parameter IDs
  dups <- sum(duplicated(params$impcParameterOrigId))
  cat("Duplicate parameter IDs:", dups, "\n")
  
  # Check that procedures reference parameters and whether there are missing references
  missing <- anti_join(procs, params, by = "impcParameterOrigId")
  missing_ids <- unique(missing$impcParameterOrigId)
  
  cat("Procedure IDs missing from parameters:", length(missing_ids), "\n")
  if (length(missing_ids) > 0) {
    cat("Examples:", paste(head(missing_ids, 3), collapse = ", "), "\n")
  }
  cat("\n")
}
```

# Checking the Parameter and Procedure Relationship

```{r}
check_integrity(IMPC_parameter, IMPC_procedure)
# 14 duplicate parameter IDs - as seen before
# 0 procedure IDs missing from parameters
```

# Checking capitalization and spacing format

## 1. Disease Information

```{r}
# Checking that DO_Disease_Name are in standard format - beginning with capital (format of other columns already checked with check_disease_info function)
all(grepl("^[A-Z]", disease_info$DO_Disease_Name)) #FALSE

sum(grepl("^[a-z]", disease_info$DO_Disease_Name)) #2204 do not begin with capitals

# View the disease names not capitalised
diseasename_noncaps <- disease_info$DO_Disease_Name[grepl("^[a-z]", disease_info$DO_Disease_Name)]
diseasename_noncaps
```

## 2. IMPC Parameter Description

```{r}
# name Column

all(grepl("^[A-Z]", IMPC_parameter$name)) #FALSE
sum(grepl("^[a-z]", IMPC_parameter$name)) #19 do not begin with capital letter
parametername_noncaps <- IMPC_parameter$name[grepl("^[a-z]", IMPC_parameter$name)]
parametername_noncaps
# Some need capitalisation e.g. spina bifida, lateral ventricle choroid plexus etc., but others need to retain their format e.g. cDCs, rMSSD, pNN5, or those beginning with special characters

# description Column

# description format

# _ between description words
sum(grepl("_", IMPC_parameter$description)) #2215 have _ separating words
paramdescrip_missing_underscore <- IMPC_parameter$description[grepl(" ", IMPC_parameter$description)]
paramdescrip_missing_underscore #Those without _ have a cleaner description format

# Beginning with _
sum(grepl("^_", IMPC_parameter$description)) #15 begin with _ not standard format
# to view them
paramdescrip_starts_with_underscore <- IMPC_parameter$description[grepl("^_", IMPC_parameter$description)]
paramdescrip_starts_with_underscore

# Ending with _
sum(grepl("_+$", IMPC_parameter$description)) #78 end with _ not standard format
#to view them
paramdescrip_ends_with_underscore <- IMPC_parameter$description[grepl("_+$", IMPC_parameter$description)]
paramdescrip_ends_with_underscore 

# Standard format should begin capital
all(grepl("^[A-Z]", IMPC_parameter$description)) #FALSE
# to view them
paramdescrip_upper <- IMPC_parameter$description[!grepl("^[a-z]", IMPC_parameter$description)]
paramdescrip_upper
paramdescrip_not_upper <- IMPC_parameter$description[!grepl("^[A-Z]", IMPC_parameter$description)]
paramdescrip_not_upper # different formats, also shows missing descriptions (NAs), and some beginning with numbers 
# Less begin with uppercase, but for a cleaner format beginning with a capital is better

# parameter_id column

# Check that no parameter_id begin with lowercase
all(!grepl("^[a-z]", IMPC_parameter$parameter_id)) #TRUE
```

## 3. IMPC Procedure

```{r}
# Check if data begin with capital letter

# Name colummn 

all(grepl("^[A-Z]", IMPC_procedure$name)) #TRUE 

# Description column 

all(grepl("^[A-Z]", IMPC_procedure$description)) #FALSE
sum(grepl("^[a-z]", IMPC_procedure$description)) #22 do not begin with capital letter
proceduredescription_noncaps <- IMPC_procedure$description[grepl("^[a-z]", IMPC_procedure$description)]
proceduredescription_noncaps

# Should not have underscores between words
# Check for underscores
sum(grepl("_", IMPC_procedure$description)) #67 have underscores
procdescrip_underscore <- IMPC_procedure$description[grepl("_", IMPC_procedure$description)]
procdescrip_underscore
```

# Cleaning

## 1. Cleaning Disease Information

```{r}

#1. Separating rows with multiple OMIM_IDs so that they are easier to use in downstream analyses
#2. Cleaning format of names: all begin with capital letter

disease_info_clean <- disease_info %>% 
  separate_rows(OMIM_ID, sep = "\\|") %>%
  mutate(
    DO_Disease_Name = str_to_sentence(DO_Disease_Name)
  )
```

## 2. Cleaning IMPC Parameter

```{r}
#1. Cleaning formatting of description column: _ and capitalising 
#2. Cleaning formatting of name columns: capitalising
#3. Harmonizing descriptions 
#4. Removing duplicate impcParameterOrigId

IMPC_parameter_clean <- IMPC_parameter %>%
  #Cleaning description formatting
  mutate(
    description = description %>%
      str_replace_all("_", " ") %>% #Replacing _ with spaces
      str_replace("^_+", "") %>% #Removing leading _
      str_replace("_+$", "") %>% #Removing ending _
      str_to_sentence() #Beginning with uppercase
  ) %>%
  #Cleaning name formatting 
  mutate(
    name = ifelse(
      grepl("^[a-z][a-z]", name), #Only if it starts with 2 lowercase letters
      paste0(
        toupper(substr(name, 1, 1)),
        substr(name, 2, nchar(name))
      ),
      name
    )
  ) %>%
  #Harmonize descriptions by name 
  group_by(name) %>%
  mutate(
  description = {
      if (n_distinct(description, na.rm = TRUE) > 1) { 
        #Checking distinct descriptions
        #If multiple different descriptions - then need to be harmonize
        valid_descs <- description[!is.na(description)]
        if (length(valid_descs) > 0) {
          valid_descs[which.max(nchar(valid_descs))] #Looking for valid descriptions for that parameter name and assigning longest description 
        } else {
          description
        }
      } else {
        #If descriptions are the same across all rows - keep them as they are
        description
      }
    }
  ) %>%
  ungroup() %>%
  
  # Remove duplicates by impcParameterOrigId
  distinct(impcParameterOrigId, .keep_all = TRUE)
```

## 3. Cleaning IMPC Procedure

```{r}
#1. Cleaning formatting: _ and capitalising
#2. Ensuring that each row with the same procedure name has the same description 

IMPC_procedure_clean <- IMPC_procedure %>%
  #Clean description
  mutate(
    description = description %>%
      str_replace_all("_", "") %>% #Replacing _ with spaces
      str_to_sentence() #Capitalising first letter
  ) %>%
  group_by(name) %>% #Groups by name
  mutate(description = {
    valid_descs <- description[!is.na(description)] #Contains only non NA, valid descriptions
    if (length(valid_descs) > 0) {
      valid_descs[which.max(nchar(valid_descs))] #finds the longest description within a name group and replaces them if they do not match
    } else {
      description
    }
  }) %>%
  ungroup() %>%
  distinct()
```

# Check

## 1. Checking Disease Information

```{r}

# Check for multi-OMIM IDs
check_disease_info(disease_info_clean)
# 0 multi-OMIM IDs

# Check DO_Disease_Name begins with capital
all(grepl("^[A-Z]", disease_info_clean$DO_Disease_Name)) #FALSE

# Check why:

sum(str_detect(disease_info_clean$DO_Disease_Name, "^[0-9]")) #4 start with number

# Checks that besides the entries that start with a number, the rest begin with capitals
all(grepl("^[A-Z]", disease_info_clean$DO_Disease_Name[!grepl("^[0-9]", disease_info_clean$DO_Disease_Name)]), na.rm = TRUE) #TRUE 
```

## 2. Checking IMPC Parameter

```{r}
audit_file(IMPC_parameter_clean, "IMPC Parameter Cleaned Descriptions")
#0 duplicates

sum(grepl("_", IMPC_parameter_clean$description)) #0 have _
sum(grepl("^_", IMPC_parameter_clean$description)) #0 begin with _
sum(grepl("_+$", IMPC_parameter_clean$description)) #0 end with _

all(grepl("^[A-Z]", IMPC_parameter_clean$name)) #FALSE

# Check why:
sum(grepl("^[A-Z]", IMPC_parameter_clean$name)) #5222 capitals
sum(!grepl("^[A-Z]", IMPC_parameter_clean$name)) #89 do not begin with capitals 
# Check:
IMPC_parameter_clean$name[!grepl("^[A-Z]", IMPC_parameter_clean$name)] #those that start with numbers, %, special characters, or their format needed to be preserved this way
# E.g. Has not capitalised those that start with a special character or begin with lowercase followed by uppercase
IMPC_parameter_clean %>%
  filter(!str_detect(name, "^[A-Z0-9%]"))

sum(grepl("^[a-z]", IMPC_parameter_clean$description)) #0 begin with lower case letter 
```

## 3. Checking IMPC Procedure

```{r}
all(grepl("^[A-Z]", IMPC_procedure_clean$description)) #FALSE

# Check why:
sum(grepl("^[A-Z]", IMPC_procedure_clean$description)) #2056 rows in capital
sum(is.na(IMPC_procedure_clean$description)) #3255 rows are NA/empty fields
# 5311 total rows, therefore all descriptions are in capital, cleaning has worked
```

# Dealing with non-IMPC Parameter ID
```{r}
# Loading cleaned data
clean_data <- read.csv("/scratch/grp/msc_appbio/DCDM/Group3/processed_data/clean_merged_data.csv", sep = ",", header = TRUE)
head(clean_data$parameter_id)

# Extracting all parameter_ids from data that are not in the IMPC Parameter metadata (missing), do not begin with IMPC... e.g. ESLIM..., HMGULA..., M_G_P... 
mismatched_id <- clean_data[!(clean_data$parameter_id %in% IMPC_parameter_clean$parameter_id), ]
# Extracting all of the unique mismatched parameter IDs
missing_id <- unique(mismatched_id$parameter_id)
print(paste("Number of missing parameter IDs:", length(missing_id))) #54 non IMPC missing parameter_id
print(missing_id)

# Building new parameter records for these, matching the column structure of IMPC_parameter_clean
new_parameter_id <- mismatched_id %>%
  select(parameter_id, parameter_name) %>%
  distinct() %>%
  arrange(parameter_id) %>%
  mutate(
    impcParameterOrigId = as.character(99999 + row_number()),
    name = parameter_name,
    parameter_id = parameter_id,
    description = "Generated during R cleaning due to missing Parameter ID metadata"
  ) %>%
  select(colnames(IMPC_parameter_clean))


# Adding the missing parameter_ids to the IMPC Parameter description metadata with the appropriate description 
IMPC_parameter_clean_final <- bind_rows(IMPC_parameter_clean, new_parameter_id)
```

# Saving as new .csv
```{r}
write.csv(disease_info_clean, file = "/scratch/grp/msc_appbio/DCDM/Group3/processed_data/disease_information_clean.csv",
          row.names = FALSE)

write.csv(IMPC_parameter_clean_final, file = "/scratch/grp/msc_appbio/DCDM/Group3/processed_data/IMPC_parameter_clean.csv",
          row.names = FALSE)

write.csv(IMPC_procedure_clean, file = "/scratch/grp/msc_appbio/DCDM/Group3/processed_data/IMPC_procedure_clean.csv",
          row.names = FALSE)
```

